name: PR - Security Scans + Unit Tests

on:
  pull_request:
    branches: ["main"]
    paths:
      - '**/*.py'
      - 'requirements.txt'
      - 'pyproject.toml'
      - '**/*.bicep'
      - 'infra/**'

  workflow_dispatch: {}

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  security_scans:
    name: ğŸ”’ Security Scans
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install Security Tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit checkov bandit safety
          sudo apt-get update && sudo apt-get install -y jq

      # 1. CODE QUALITY & SAST
      - name: ğŸ” CodeQL Analysis (SAST)
        uses: github/codeql-action/init@v3
        with:
          languages: python
          queries: security-and-quality

      - name: ğŸ“Š CodeQL Analyze
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"

      - name: ğŸ Bandit SAST Scan
        run: |
          bandit -r . -f json -o bandit-results.json || true
        continue-on-error: true

      # 2. DEPENDENCY SECURITY ANALYSIS
      - name: ğŸ“‹ Analyze Dependencies
        id: deps-check
        run: |
          echo "# ğŸ“¦ Dependency Security Report" > $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Create a Python script for analysis
          cat > analyze_deps.py << 'EOF'
import re
import json
import subprocess
import sys

def check_unpinned_packages():
    unpinned = []
    try:
        with open('requirements.txt', 'r') as f:
            for line in f:
                line = line.strip()
                if line and not line.startswith('#'):
                    # Check if package is pinned
                    if not ('==' in line or '>=' in line or '<=' in line or '~=' in line):
                        unpinned.append(line)
    except FileNotFoundError:
        print("No requirements.txt found")
        return []
    
    return unpinned

def run_vulnerability_scan():
    try:
        # Install packages first
        subprocess.run(['pip', 'install', '-r', 'requirements.txt'], 
                      capture_output=True, text=True)
        
        # Run pip-audit
        result = subprocess.run(['pip-audit', '--format', 'json', '--output', 'pip-audit.json'],
                              capture_output=True, text=True)
        
        if result.returncode == 0:
            with open('pip-audit.json', 'r') as f:
                data = json.load(f)
            return data.get('vulnerabilities', [])
    except Exception as e:
        print(f"Error in vulnerability scan: {e}")
    
    return None

def main():
    print("## ğŸ” Unpinned Dependencies Analysis")
    unpinned = check_unpinned_packages()
    
    if unpinned:
        print(f"### âŒ **{len(unpinned)} Unpinned Package(s) Found**")
        print("")
        for pkg in unpinned:
            print(f"- **{pkg}** - âš ï¸ Not version pinned")
        print("")
        print("**Security Impact:**")
        print("- Automatic updates could introduce vulnerable versions")
        print("- Inconsistent builds across environments")
        print("- Difficulty reproducing issues")
        print("")
        print("**Recommended Action:**")
        print("```bash")
        print("# Generate pinned requirements:")
        print("pip install -r requirements.txt")
        print("pip freeze > requirements.txt")
        print("```")
    else:
        print("### âœ… **All Dependencies Are Properly Pinned**")
        print("")
        print("Good practice: Dependencies are locked to specific versions.")
    
    print("")
    print("## ğŸ” Vulnerability Scan (pip-audit)")
    
    vulns = run_vulnerability_scan()
    if vulns is not None:
        if vulns:
            print(f"### ğŸš¨ **{len(vulns)} Vulnerability(ies) Found**")
            print("")
            for vuln in vulns:
                name = vuln.get('name', 'Unknown')
                version = vuln.get('installed_version', '')
                desc = vuln.get('description', 'No description')
                cve = vuln.get('id', 'Unknown')
                print(f"- **{name} {version}**: {desc} [CVE: {cve}]")
            
            # Create SARIF output
            create_sarif(vulns)
        else:
            print("### âœ… **No Vulnerabilities Found**")
            print("")
            print("All scanned packages are free of known vulnerabilities.")
    else:
        print("### âš ï¸ **Vulnerability Scan Incomplete**")
        print("")
        print("Could not complete vulnerability scan.")
        print("")
        print("**Fix unpinned packages first for complete security scan.**")
    
    print("")
    print("## ğŸ“Š Summary")
    print(f"- **Unpinned Dependencies:** {len(unpinned)}")
    print(f"- **Vulnerabilities Found:** {len(vulns) if vulns else 'Unknown'}")
    
    # Set outputs
    with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
        fh.write(f'UNPINNED_COUNT={len(unpinned)}\n')
        fh.write(f'VULN_COUNT={len(vulns) if vulns else 0}\n')

def create_sarif(vulns):
    sarif = {
        "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
        "version": "2.1.0",
        "runs": [{
            "tool": {
                "driver": {
                    "name": "pip-audit",
                    "informationUri": "https://pypi.org/project/pip-audit/",
                    "version": "2.0+"
                }
            },
            "results": []
        }]
    }
    
    for vuln in vulns:
        sarif["runs"][0]["results"].append({
            "ruleId": vuln.get('id', 'Unknown'),
            "level": "error",
            "message": {
                "text": f"{vuln.get('name', 'Unknown')} {vuln.get('installed_version', '')}: {vuln.get('description', 'Vulnerability found')}"
            },
            "locations": [{
                "physicalLocation": {
                    "artifactLocation": {
                        "uri": "requirements.txt"
                    }
                }
            }]
        })
    
    with open('pip-audit.sarif', 'w') as f:
        json.dump(sarif, f, indent=2)

if __name__ == "__main__":
    main()
EOF
          
          python analyze_deps.py >> $GITHUB_STEP_SUMMARY
          
          # Ensure outputs are set even if script fails
          echo "UNPINNED_COUNT=${UNPINNED_COUNT:-0}" >> $GITHUB_OUTPUT
          echo "VULN_COUNT=${VULN_COUNT:-0}" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: ğŸ“¤ Upload pip-audit Results
        if: always() && hashFiles('pip-audit.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: pip-audit.sarif
          category: pip-audit

      - name: ğŸ“¤ Upload Bandit Results
        if: always() && hashFiles('bandit-results.json') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: bandit-results.json
          category: bandit

      # 3. INFRASTRUCTURE SCAN
      - name: ğŸ—ï¸ IaC Security Scan
        run: |
          if [ -d "infra" ] || find . -name "*.bicep" -print -quit | grep -q .; then
            checkov -d . --framework bicep --output sarif --output-file-path checkov-bicep.sarif --quiet || true
          else
            echo "No IaC files found to scan"
          fi
        continue-on-error: true

      - name: ğŸ“¤ Upload Checkov Results
        if: always() && hashFiles('checkov-bicep.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov-bicep.sarif
          category: checkov-bicep

  unit_tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: security_scans
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: ğŸ§ª Run Tests
        run: |
          pytest --cov=. --cov-report=xml --junitxml=junit.xml -v || exit 1

      - name: ğŸ“Š Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            junit.xml
            coverage.xml