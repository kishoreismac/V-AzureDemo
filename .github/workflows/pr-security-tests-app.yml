name: PR - Security Scans + Unit Tests

on:
  pull_request:
    branches: ["main"]
    paths:
      - '**/*.py'
      - 'requirements.txt'
      - 'pyproject.toml'
      - '**/*.bicep'
      - 'infra/**'

  workflow_dispatch: {}

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  security_scans:
    name: üîí Security Scans
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: üì¶ Install Security Tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit checkov bandit safety
          sudo apt-get update && sudo apt-get install -y jq

      # 1. CODE QUALITY & SAST
      - name: üîç CodeQL Analysis (SAST)
        uses: github/codeql-action/init@v3
        with:
          languages: python
          queries: security-and-quality

      - name: üìä CodeQL Analyze
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"

      - name: üêç Bandit SAST Scan
        run: |
          bandit -r . -f json -o bandit-results.json 2>/dev/null || echo "Bandit scan completed"
        continue-on-error: true

      # 2. DEPENDENCY SECURITY ANALYSIS
      - name: üìã Check for Unpinned Dependencies
        id: check-deps
        run: |
          echo "# üì¶ Dependency Security Report" > $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for unpinned packages using simple bash
          UNPINNED_COUNT=0
          UNPINNED_LIST=""
          
          if [ -f "requirements.txt" ]; then
            while IFS= read -r line; do
              line_clean=$(echo "$line" | xargs)
              if [[ -n "$line_clean" ]] && [[ ! "$line_clean" =~ ^# ]]; then
                if [[ ! "$line_clean" =~ == ]] && [[ ! "$line_clean" =~ \>= ]] && [[ ! "$line_clean" =~ \<= ]]; then
                  ((UNPINNED_COUNT++))
                  PKG_NAME=$(echo "$line_clean" | awk '{print $1}')
                  UNPINNED_LIST+="- **$PKG_NAME** - ‚ö†Ô∏è Not version pinned"$'\n'
                fi
              fi
            done < requirements.txt
          fi
          
          if [ $UNPINNED_COUNT -gt 0 ]; then
            echo "## üîç Unpinned Dependencies Analysis" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ‚ùå **$UNPINNED_COUNT Unpinned Package(s) Found**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "$UNPINNED_LIST" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Security Impact:**" >> $GITHUB_STEP_SUMMARY
            echo "- Automatic updates could introduce vulnerable versions" >> $GITHUB_STEP_SUMMARY
            echo "- Inconsistent builds across environments" >> $GITHUB_STEP_SUMMARY
            echo "- Difficulty reproducing issues" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Recommended Action:**" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo '# Generate pinned requirements:' >> $GITHUB_STEP_SUMMARY
            echo 'pip install -r requirements.txt' >> $GITHUB_STEP_SUMMARY
            echo 'pip freeze > requirements.txt' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "## üîç Unpinned Dependencies Analysis" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ‚úÖ **All Dependencies Are Properly Pinned**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Good practice: Dependencies are locked to specific versions." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "UNPINNED_COUNT=$UNPINNED_COUNT" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: üîê Run Vulnerability Scan
        id: vuln-scan
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üîê Vulnerability Scan (pip-audit)" >> $GITHUB_STEP_SUMMARY
          
          # Try to install and scan
          VULN_COUNT=0
          
          if [ -f "requirements.txt" ]; then
            # Install packages first
            pip install -r requirements.txt 2>/dev/null || true
            
            # Run pip-audit
            if pip-audit --format json --output pip-audit.json 2>/dev/null; then
              if [ -f "pip-audit.json" ]; then
                VULN_COUNT=$(jq '.vulnerabilities | length' pip-audit.json 2>/dev/null || echo "0")
                
                if [ "$VULN_COUNT" -gt 0 ] 2>/dev/null && [ "$VULN_COUNT" != "null" ]; then
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### üö® **$VULN_COUNT Vulnerability(ies) Found**" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  
                  # Show first 5 vulnerabilities
                  jq -r '.vulnerabilities[0:5][] | "- **\(.name) \(.installed_version)**: \(.description // "No description") [CVE: \(.id)]"' pip-audit.json 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "Could not parse vulnerability details" >> $GITHUB_STEP_SUMMARY
                  
                  if [ "$VULN_COUNT" -gt 5 ]; then
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "*... and $((VULN_COUNT - 5)) more. Check the Security tab for full details.*" >> $GITHUB_STEP_SUMMARY
                  fi
                  
                  # Create SARIF file
                  cat > create_sarif.py << 'EOF'
import json
import sys

try:
    with open('pip-audit.json', 'r') as f:
        data = json.load(f)
    
    sarif = {
        "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
        "version": "2.1.0",
        "runs": [{
            "tool": {
                "driver": {
                    "name": "pip-audit",
                    "informationUri": "https://pypi.org/project/pip-audit/"
                }
            },
            "results": []
        }]
    }
    
    for vuln in data.get('vulnerabilities', []):
        sarif["runs"][0]["results"].append({
            "ruleId": vuln.get('id', 'Unknown'),
            "level": "error",
            "message": {
                "text": f"{vuln.get('name', 'Unknown')} {vuln.get('installed_version', '')}: {vuln.get('description', 'Vulnerability found')}"
            },
            "locations": [{
                "physicalLocation": {
                    "artifactLocation": {
                        "uri": "requirements.txt"
                    }
                }
            }]
        })
    
    with open('pip-audit.sarif', 'w') as f:
        json.dump(sarif, f, indent=2)
    
    print("SARIF file created successfully")
except Exception as e:
    print(f"Error creating SARIF: {e}")
    sys.exit(1)
EOF
                  python create_sarif.py
                  
                else
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### ‚úÖ **No Vulnerabilities Found**" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "All scanned packages are free of known vulnerabilities." >> $GITHUB_STEP_SUMMARY
                fi
              fi
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### ‚ö†Ô∏è **Vulnerability Scan Incomplete**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Could not complete vulnerability scan." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ‚ÑπÔ∏è **No requirements.txt found**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìä Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Unpinned Dependencies:** ${{ steps.check-deps.outputs.UNPINNED_COUNT }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Vulnerabilities Found:** $VULN_COUNT" >> $GITHUB_STEP_SUMMARY
          
          echo "VULN_COUNT=$VULN_COUNT" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: üì§ Upload pip-audit Results
        if: always() && hashFiles('pip-audit.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: pip-audit.sarif
          category: pip-audit

      - name: üì§ Upload Bandit Results
        if: always() && hashFiles('bandit-results.json') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: bandit-results.json
          category: bandit

      # 3. INFRASTRUCTURE SCAN
      - name: üèóÔ∏è IaC Security Scan
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üèóÔ∏è Infrastructure Security Scan" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "infra" ] || find . -name "*.bicep" -type f | head -1 | grep -q "."; then
            checkov -d . --framework bicep --output sarif --output-file-path checkov-bicep.sarif --quiet || true
            
            if [ -f "checkov-bicep.sarif" ]; then
              CHECK_COUNT=$(jq '.runs[0].results | length' checkov-bicep.sarif 2>/dev/null || echo "0")
              
              if [ "$CHECK_COUNT" -gt 0 ] 2>/dev/null; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "### ‚ö†Ô∏è **$CHECK_COUNT IaC Finding(s)**" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "Check the Security tab for detailed findings." >> $GITHUB_STEP_SUMMARY
              else
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "### ‚úÖ **No IaC Security Issues Found**" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ‚ÑπÔ∏è **No IaC Files Found to Scan**" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: üì§ Upload Checkov Results
        if: always() && hashFiles('checkov-bicep.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov-bicep.sarif
          category: checkov-bicep

  unit_tests:
    name: üß™ Unit Tests
    runs-on: ubuntu-latest
    needs: security_scans
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: üì¶ Install Dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: üß™ Run Tests
        run: |
          echo "## üß™ Test Results" > $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if pytest --cov=. --cov-report=xml --cov-report=term-missing --junitxml=junit.xml -v; then
            echo "### ‚úÖ **All Tests Passed**" >> $GITHUB_STEP_SUMMARY
            
            # Get coverage percentage
            if [ -f "coverage.xml" ]; then
              COVERAGE=$(grep -o 'line-rate="[^"]*"' coverage.xml | cut -d'"' -f2)
              if [ ! -z "$COVERAGE" ]; then
                COVERAGE_PCT=$(echo "$COVERAGE * 100" | bc -l | xargs printf "%.1f")
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "**Coverage: ${COVERAGE_PCT}%**" >> $GITHUB_STEP_SUMMARY
                
                if (( $(echo "$COVERAGE_PCT < 70" | bc -l) )); then
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "‚ö†Ô∏è **Low coverage detected (< 70%). Consider adding more tests.**" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            fi
          else
            echo "### ‚ùå **Tests Failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check test output for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: üìä Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            junit.xml
            coverage.xml

  post_security_review:
    name: üìã Security Review Summary
    runs-on: ubuntu-latest
    needs: [security_scans, unit_tests]
    if: always()
    permissions:
      pull-requests: write

    steps:
      - name: üìù Create Security Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `
            ## üîí Security Review Summary

            ### üìã Scan Results
            Security scans have completed for this PR. Here's what we found:

            #### ‚ö†Ô∏è **Attention Needed:**
            - **Unpinned Dependencies**: ${{ needs.security_scans.outputs.UNPINNED_COUNT || 0 }} package(s) not version-locked
            - **Vulnerabilities**: ${{ needs.security_scans.outputs.VULN_COUNT || 0 }} CVE(s) detected
            - **Risk**: Unpinned packages could automatically pull vulnerable versions

            #### ‚úÖ **Completed Scans:**
            1. **SAST (CodeQL)**: Static application security testing
            2. **Dependency Analysis**: Version pinning check
            3. **Vulnerability Scan**: CVE detection
            4. **IaC Security**: Bicep template validation
            5. **Unit Tests**: Code quality and coverage

            ### üõ†Ô∏è **Recommended Actions:**
            \`\`\`bash
            # Fix unpinned dependencies:
            pip install -r requirements.txt
            pip freeze > requirements.txt
            
            # Review security findings in:
            # 1. GitHub Security tab
            # 2. Workflow run summary
            \`\`\`

            ### üìä **Next Steps:**
            - [ ] Review security findings in the Security tab
            - [ ] Fix unpinned dependencies in requirements.txt
            - [ ] Address critical vulnerabilities
            - [ ] Approve merge once security issues are resolved

            *üîç For detailed findings, check the "Security" tab and workflow run summary.*
            `;
            
            // Post comment on PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });