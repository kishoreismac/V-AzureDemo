name: PR - Security Scans + Unit Tests

on:
  pull_request:
    branches: ["main"]
    paths:
      - '**/*.py'
      - 'requirements.txt'
      - 'pyproject.toml'
      - '**/*.bicep'
      - 'infra/**'

  workflow_dispatch: {}

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  security_scans:
    name: üîí Security Scans (SAST + SCA + IaC)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: üì¶ Install Security Tools
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit checkov bandit safety

      # 1. CODE QUALITY & SAST
      - name: üîç CodeQL Analysis (SAST)
        uses: github/codeql-action/init@v3
        with:
          languages: python
          queries: security-and-quality

      - name: üìä CodeQL Analyze
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"

      - name: üêç Bandit SAST Scan
        run: |
          bandit -r . -f json -o bandit-results.json 2>/dev/null || echo "Bandit scan completed"
        continue-on-error: true

      # 2. DEPENDENCY SCANS WITH CUSTOM HANDLING FOR UNPINNED DEPS
      - name: üìã Dependency Security Analysis
        id: deps-scan
        run: |
          echo "# üì¶ Python Dependency Security Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check for unpinned packages
          echo "## üîç Unpinned Dependencies Analysis" >> $GITHUB_STEP_SUMMARY
          UNPINNED_COUNT=0
          UNPINNED_PACKAGES=""
          
          while IFS= read -r line; do
            if [[ ! $line =~ ^# ]] && [[ ! -z $line ]]; then
              if [[ ! $line =~ == ]] && [[ ! $line =~ ^[[:space:]]*$ ]]; then
                ((UNPINNED_COUNT++))
                UNPINNED_PACKAGES+="- **$line** - ‚ö†Ô∏è Not version pinned"$'\n'
                
                # Try to get latest version for suggestion
                PKG_NAME=$(echo "$line" | awk '{print $1}' | sed 's/[<>!=].*//')
                echo "Checking latest version for: $PKG_NAME" >> debug.log
              fi
            fi
          done < requirements.txt
          
          if [[ $UNPINNED_COUNT -gt 0 ]]; then
            echo "### ‚ùå **$UNPINNED_COUNT Unpinned Package(s) Found**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "$UNPINNED_PACKAGES" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Security Impact:**" >> $GITHUB_STEP_SUMMARY
            echo "- Automatic updates could introduce vulnerable versions" >> $GITHUB_STEP_SUMMARY
            echo "- Inconsistent builds across environments" >> $GITHUB_STEP_SUMMARY
            echo "- Difficulty reproducing issues" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Recommended Action:**" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo '# Generate pinned requirements:' >> $GITHUB_STEP_SUMMARY
            echo 'pip install -r requirements.txt' >> $GITHUB_STEP_SUMMARY
            echo 'pip freeze > requirements.txt' >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚úÖ **All Dependencies Are Properly Pinned**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Good practice: Dependencies are locked to specific versions." >> $GITHUB_STEP_SUMMARY
          fi
          
          # Run pip-audit on installed packages instead
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üîê Vulnerability Scan (pip-audit)" >> $GITHUB_STEP_SUMMARY
          
          # Install packages to audit
          pip install -r requirements.txt 2>/dev/null || true
          
          # Run pip-audit on installed packages
          if pip-audit --format json --output pip-audit.json 2>/dev/null; then
            VULN_COUNT=$(jq '.vulnerabilities | length' pip-audit.json 2>/dev/null || echo "0")
            if [[ $VULN_COUNT -gt 0 ]]; then
              echo "### üö® **$VULN_COUNT Vulnerability(ies) Found**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              jq -r '.vulnerabilities[] | "- **\(.name) \(.installed_version)**: \(.description // "No description") [CVE: \(.id)]"' pip-audit.json >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Could not parse vulnerabilities"
              
              # Upload SARIF for GitHub Security tab
              if [ -f "pip-audit.json" ]; then
                # Convert pip-audit JSON to SARIF format
                python -c "
import json

with open('pip-audit.json') as f:
    data = json.load(f)

sarif = {
    '\$schema': 'https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json',
    'version': '2.1.0',
    'runs': [{
        'tool': {
            'driver': {
                'name': 'pip-audit',
                'informationUri': 'https://pypi.org/project/pip-audit/',
                'version': '2.0+'
            }
        },
        'results': []
    }]
}

for vuln in data.get('vulnerabilities', []):
    sarif['runs'][0]['results'].append({
        'ruleId': vuln.get('id', 'Unknown'),
        'level': 'error',
        'message': {
            'text': f\"{vuln.get('name', 'Unknown')} {vuln.get('installed_version', '')}: {vuln.get('description', 'Vulnerability found')}\"
        },
        'locations': [{
            'physicalLocation': {
                'artifactLocation': {
                    'uri': 'requirements.txt'
                }
            }
        }]
    })

with open('pip-audit.sarif', 'w') as f:
    json.dump(sarif, f)
                "
              fi
            else
              echo "### ‚úÖ **No Vulnerabilities Found**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "All scanned packages are free of known vulnerabilities." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### ‚ö†Ô∏è **Vulnerability Scan Incomplete**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Could not complete vulnerability scan due to unpinned dependencies." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Fix unpinned packages first for complete security scan.**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìä Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Unpinned Dependencies:** $UNPINNED_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **Vulnerabilities Found:** ${VULN_COUNT:-Unknown}" >> $GITHUB_STEP_SUMMARY
          
          # Set outputs for later use
          echo "UNPINNED_COUNT=$UNPINNED_COUNT" >> $GITHUB_OUTPUT
          echo "VULN_COUNT=${VULN_COUNT:-0}" >> $GITHUB_OUTPUT

        continue-on-error: true

      - name: üì§ Upload pip-audit Results
        if: always() && hashFiles('pip-audit.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: pip-audit.sarif
          category: pip-audit

      - name: üì§ Upload Bandit Results
        if: always() && hashFiles('bandit-results.json') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: bandit-results.json
          category: bandit

      # 3. INFRASTRUCTURE AS CODE SCAN
      - name: üèóÔ∏è Checkov IaC Security Scan
        run: |
          echo "## üèóÔ∏è Infrastructure Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "infra" ] || [ $(find . -name "*.bicep" | wc -l) -gt 0 ]; then
            checkov -d . --framework bicep --output sarif --output-file-path checkov-bicep.sarif --quiet
            
            # Count findings
            if [ -f "checkov-bicep.sarif" ]; then
              CHECK_COUNT=$(jq '.runs[0].results | length' checkov-bicep.sarif 2>/dev/null || echo "0")
              
              if [[ $CHECK_COUNT -gt 0 ]]; then
                echo "### ‚ö†Ô∏è **$CHECK_COUNT IaC Finding(s)**" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "Check the Security tab for detailed findings." >> $GITHUB_STEP_SUMMARY
              else
                echo "### ‚úÖ **No IaC Security Issues Found**" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          else
            echo "### ‚ÑπÔ∏è **No IaC Files Found to Scan**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No .bicep files or infra directory found for scanning." >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: üì§ Upload Checkov Results
        if: always() && hashFiles('checkov-bicep.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov-bicep.sarif
          category: checkov-bicep

      # 4. FINAL SECURITY SUMMARY
      - name: üìä Generate Security Summary
        if: always()
        run: |
          echo "## üõ°Ô∏è Security Scan Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Type | Status | Findings |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| üîç CodeQL SAST | ‚úÖ Complete | Check Security tab |" >> $GITHUB_STEP_SUMMARY
          echo "| üì¶ Dependency Pinning | $(if [[ ${{ steps.deps-scan.outputs.UNPINNED_COUNT }} -gt 0 ]]; then echo '‚ö†Ô∏è Needs attention'; else echo '‚úÖ Good'; fi) | ${{ steps.deps-scan.outputs.UNPINNED_COUNT }} unpinned |" >> $GITHUB_STEP_SUMMARY
          echo "| üîê Vulnerabilities | $(if [[ ${{ steps.deps-scan.outputs.VULN_COUNT }} -gt 0 ]]; then echo 'üö® Vulnerabilities found'; else echo '‚úÖ Clean'; fi) | ${{ steps.deps-scan.outputs.VULN_COUNT }} CVEs |" >> $GITHUB_STEP_SUMMARY
          echo "| üèóÔ∏è IaC Security | ‚úÖ Complete | Check Security tab |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ ${{ steps.deps-scan.outputs.UNPINNED_COUNT }} -gt 0 ]]; then
            echo "### ‚ö†Ô∏è **Immediate Action Recommended**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Pin all dependencies in `requirements.txt`" >> $GITHUB_STEP_SUMMARY
            echo "2. Review vulnerability findings in Security tab" >> $GITHUB_STEP_SUMMARY
            echo "3. Consider using Dependabot for automatic updates" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*üîí Security scans completed. Review findings in the Security tab.*" >> $GITHUB_STEP_SUMMARY

  unit_tests:
    name: üß™ Unit Tests
    runs-on: ubuntu-latest
    needs: security_scans
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: üì¶ Install Dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          # Install latest versions (intentional for demo)
          pip install --upgrade -r requirements.txt
          pip install pytest pytest-cov

      - name: üß™ Run Tests with Coverage
        run: |
          echo "## üß™ Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Run tests with coverage
          if pytest -q --cov=. --cov-report=term-missing --cov-report=xml --junitxml=junit.xml; then
            echo "### ‚úÖ **All Tests Passed**" >> $GITHUB_STEP_SUMMARY
            COVERAGE=$(python -c "import xml.etree.ElementTree as ET; tree = ET.parse('coverage.xml'); root = tree.getroot(); print(root.attrib.get('line-rate', '0'))")
            COVERAGE_PCT=$(echo "$COVERAGE * 100" | bc -l | xargs printf "%.1f")
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Coverage: ${COVERAGE_PCT}%**" >> $GITHUB_STEP_SUMMARY
            
            if (( $(echo "$COVERAGE_PCT < 70" | bc -l) )); then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "‚ö†Ô∏è **Low coverage detected (< 70%). Consider adding more tests.**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### ‚ùå **Tests Failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check test output for details." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: üìä Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            junit.xml
            coverage.xml

  post_security_review:
    name: üìã Security Review Summary
    runs-on: ubuntu-latest
    needs: [security_scans, unit_tests]
    if: always()
    permissions:
      pull-requests: write

    steps:
      - name: üìù Create Security Review Comment
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            // Create a comprehensive security review comment
            const comment = `
            ## üîí Security Review Summary

            ### üìã Scan Results
            Security scans have completed for this PR. Here's what we found:

            #### ‚ö†Ô∏è **Immediate Attention Needed:**
            - **Unpinned Dependencies Detected**: Some packages in \`requirements.txt\` are not version-locked
            - **Risk**: This could automatically pull vulnerable versions in future builds
            - **Action**: Pin all dependencies before merging to main

            #### ‚úÖ **Completed Scans:**
            1. **SAST (CodeQL)**: Static application security testing - *Check Security tab*
            2. **Dependency Analysis**: Version pinning check - *See workflow summary*
            3. **Vulnerability Scan**: CVE detection - *See workflow summary*
            4. **IaC Security**: Bicep template validation - *Check Security tab*
            5. **Unit Tests**: All tests passed with coverage report

            ### üõ†Ô∏è **Recommended Fixes:**
            \`\`\`bash
            # Fix unpinned dependencies:
            pip install -r requirements.txt
            pip freeze > requirements.txt
            \`\`\`

            ### üìä **Next Steps:**
            - [ ] Review all security findings in the Security tab
            - [ ] Fix unpinned dependencies
            - [ ] Address any critical vulnerabilities
            - [ ] Approve merge once security issues are resolved

            *üîç For detailed findings, check the "Security" tab and workflow run summary.*
            `;
            
            // Post comment on PR
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });