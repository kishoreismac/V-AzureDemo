name: PR - Security Scans + Unit Tests (Python + Bicep)

on:
  pull_request:
    branches: ["main"]
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  security_scans:
    name: Security scans (CodeQL + pip-audit + Checkov)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python (for tooling)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install security tools only
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit checkov

      # CodeQL (Python SAST)
      - name: Initialize CodeQL (Python)
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: CodeQL Analyze
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"

      # Dependency scan (requirements only)
      - name: pip-audit (SARIF)
        run: |
          pip-audit -r requirements.txt --format sarif --output pip-audit.sarif

      - name: Upload pip-audit results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: pip-audit.sarif
          category: pip-audit

      # IaC scan (Bicep)
      - name: Checkov scan (Bicep) -> SARIF
        run: |
          checkov -d infra --framework bicep --output sarif --output-file-path checkov-bicep.sarif

      - name: Upload Checkov Bicep results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov-bicep.sarif
          category: checkov-bicep

  unit_tests:
    name: Unit tests (non-blocking for security demo)
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install app dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Run unit tests with coverage gate
        run: |
          pytest -q --cov=. --cov-report=term-missing --cov-fail-under=70
