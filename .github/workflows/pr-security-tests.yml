name: PR - Tests + Security Scans (Python + Bicep)

on:
  pull_request:
    branches: ["main"]
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  tests_and_security:
    name: Unit tests + Quality + Security scans
    runs-on: ubuntu-latest

    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # -------------------------
      # 0) Python setup
      # -------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

          # Testing & quality
          pip install pytest pytest-cov

          # Pre-commit & quality tools
          pip install pre-commit black ruff detect-secrets

          # Security tools
          pip install pip-audit checkov

      # -------------------------
      # 1) Pre-commit hooks (lint, secrets, formatting)
      # -------------------------
      - name: Run pre-commit hooks
        run: |
          pre-commit run --all-files

      # -------------------------
      # 2) Unit tests + coverage enforcement
      # -------------------------
      - name: Run unit tests with coverage
        run: |
          pytest \
            --cov=. \
            --cov-report=term-missing \
            --cov-fail-under=70

      # -------------------------
      # 3) Security: CodeQL (Python SAST)
      # -------------------------
      - name: Initialize CodeQL (Python)
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: CodeQL Analyze
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"

      # -------------------------
      # 4) Security: Dependency vulnerabilities (pip-audit)
      # -------------------------
      - name: pip-audit (SARIF)
        run: |
          pip-audit -r requirements.txt --format sarif --output pip-audit.sarif

      - name: Upload pip-audit results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: pip-audit.sarif
          category: pip-audit

      # -------------------------
      # 5) Security: IaC scan (Bicep) using Checkov
      # -------------------------
      - name: Checkov scan (Bicep) -> SARIF
        run: |
          checkov \
            -d infra \
            --framework bicep \
            --output sarif \
            --output-file-path checkov-bicep.sarif

      - name: Upload Checkov Bicep results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov-bicep.sarif
          category: checkov-bicep
