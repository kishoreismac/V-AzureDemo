name: PR - Tests + Security Scans (Python + Bicep)

on:
  pull_request:
    branches: ["main"]
  workflow_dispatch: {}

# Least privilege at workflow level
permissions:
  contents: read

jobs:
  tests_and_security:
    name: Unit tests + Security scans
    runs-on: ubuntu-latest

    # These permissions are required to upload SARIF results to GitHub Security > Code scanning
    permissions:
      contents: read
      security-events: write
      actions: read   # helpful for some private-repo scenarios

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # -------------------------
      # 1) Python unit tests (you already have these)
      # -------------------------
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # test + security tools
          pip install pytest pip-audit

      - name: Run unit tests
        run: |
          pytest -q

      # -------------------------
      # 2) Security: Code scanning (Python) - CodeQL
      # Shows in Security -> Code scanning automatically
      # -------------------------
      - name: Initialize CodeQL (Python)
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: CodeQL Analyze
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"

      # -------------------------
      # 3) Security: Dependency vulnerabilities (pip-audit) -> upload SARIF
      # Shows in Security -> Code scanning (as a SARIF upload)
      # -------------------------
      - name: pip-audit (SARIF)
        run: |
          pip-audit -r requirements.txt --format sarif --output pip-audit.sarif

      - name: Upload pip-audit results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: pip-audit.sarif
          category: pip-audit

      # -------------------------
      # 4) Security: IaC scan for Bicep (compile to ARM JSON -> Checkov) -> upload SARIF
      # Shows in Security -> Code scanning (as a SARIF upload)
      # -------------------------
      - name: Setup Azure CLI (for bicep build)
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az bicep version

            # -------------------------
      # Security: IaC scan (Bicep) using Checkov
      # -------------------------
      - name: Install Checkov
        run: |
          pip install checkov

      # Adjust path if your bicep files live elsewhere
      - name: Checkov scan (Bicep) -> SARIF
        run: |
          checkov \
            -d infra \
            --framework bicep \
            --output sarif \
            --output-file-path checkov-bicep.sarif

      - name: Upload Checkov Bicep results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov-bicep.sarif
          category: checkov-bicep
